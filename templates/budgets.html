<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budgets â€” SmartMail Expense Tracker</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="/static/js/app.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/dashboard" style="text-decoration:none;color:#f1f5f9;display:flex;align-items:center;gap:8px;">
                <img src="/static/logo.svg" alt="SmartMail Logo" class="nav-logo">
                <span class="nav-brand-text">SmartMail Tracker</span>
            </a>
        </div>
        <div class="nav-links">
            <a href="/dashboard" class="nav-link">Dashboard</a>
            <a href="/subscriptions" class="nav-link">Subscriptions</a>
            <a href="/budgets" class="nav-link active">Budgets</a>
            <a href="/investments" class="nav-link">Investments</a>
            <a href="/calendar" class="nav-link">Calendar</a>
            <a href="/reports" class="nav-link">Reports</a>
            <a href="/settings" class="nav-link">Settings</a>
            <a href="/notifications" class="nav-link notif-bell" title="Notifications">ğŸ””<span id="notifBadge"
                    class="notif-badge" style="display:none;">0</span></a>
            <span style="color:#64748b;font-size:0.85rem;margin-left:0.5rem;">{{ username }}</span>
            <button onclick="logout()" class="btn-logout"
                style="background:none;border:1px solid rgba(255,255,255,0.08);padding:6px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;color:#64748b;">Logout</button>
        </div>
    </nav>

    <div class="container" style="max-width:1100px;margin:0 auto;padding:2rem 1.5rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;">
            <div>
                <h1 style="font-size:1.8rem;font-weight:700;color:#f1f5f9;margin:0;">ğŸ’° Smart Budgets</h1>
                <p style="color:#64748b;font-size:0.9rem;margin:0.3rem 0 0;">Set spending limits per category & get
                    automatic alerts</p>
            </div>
            <button onclick="showAddBudget()" class="btn btn-primary" style="padding:8px 16px;font-size:0.85rem;">+
                Create Budget</button>
        </div>

        <!-- Budget Status Cards -->
        <div id="budgetCards"
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.25rem;margin-bottom:2rem;">
            <div style="text-align:center;color:#94a3b8;padding:3rem;grid-column:1/-1;">Loading budgets...</div>
        </div>

        <!-- Budget List Fallback -->
        <div class="settings-card" style="border-radius:16px;padding:1.5rem;">
            <h3 style="margin:0 0 1rem;font-size:1.1rem;color:#f1f5f9;">All Budgets</h3>
            <div id="budgetList"></div>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div id="budgetModal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
        <div style="background:white;border-radius:16px;padding:2rem;max-width:440px;width:90%;">
            <h3 style="margin:0 0 1.5rem;font-size:1.2rem;">Create Budget</h3>
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <select id="budgetCategory" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;">
                    <option value="Overall">ğŸ“Š Overall (All Categories)</option>
                    <option value="Food Delivery">ğŸ• Food Delivery</option>
                    <option value="Groceries">ğŸ›’ Groceries</option>
                    <option value="Online Shopping">ğŸ›ï¸ Online Shopping</option>
                    <option value="Travel & Transport">ğŸš— Travel & Transport</option>
                    <option value="Entertainment">ğŸ¬ Entertainment</option>
                    <option value="Utilities & Bills">ğŸ’¡ Utilities & Bills</option>
                    <option value="Healthcare">ğŸ¥ Healthcare</option>
                    <option value="Education">ğŸ“š Education</option>
                    <option value="EMI & Loans">ğŸ¦ EMI & Loans</option>
                    <option value="Investments">ğŸ“ˆ Investments</option>
                </select>
                <input id="budgetAmount" type="number" placeholder="Budget limit (â‚¹)" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;">
                <select id="budgetPeriod" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;">
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly (FY)</option>
                </select>
                <div>
                    <label style="font-size:0.85rem;color:#64748b;">Alert at (%)</label>
                    <input id="budgetThreshold" type="number" value="80" min="10" max="100" class="form-input"
                        style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;width:100px;">
                </div>
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1.5rem;justify-content:flex-end;">
                <button onclick="closeBudgetModal()" class="btn btn-secondary"
                    style="padding:8px 20px;font-size:0.85rem;">Cancel</button>
                <button onclick="saveBudget()" class="btn btn-primary"
                    style="padding:8px 20px;font-size:0.85rem;">Create</button>
            </div>
        </div>
    </div>

    <script>
        async function loadBudgets() {
            const data = await apiGet('/api/budgets/status');
            if (!data.success) return;

            const cards = document.getElementById('budgetCards');
            const list = document.getElementById('budgetList');

            if (!data.budgets.length) {
                cards.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:3rem;grid-column:1/-1;">No budgets yet. Click <b>+ Create Budget</b> to set spending limits.</div>';
                list.innerHTML = '';
                return;
            }

            cards.innerHTML = data.budgets.map(b => {
                const pct = Math.min(b.percentage, 100);
                const color = b.status === 'exceeded' ? '#EF476F' : b.status === 'warning' ? '#F59E0B' : '#06D6A0';
                const bg = b.status === 'exceeded' ? 'rgba(239,71,111,0.08)' : b.status === 'warning' ? 'rgba(245,158,11,0.08)' : 'rgba(6,214,160,0.08)';
                return `
                <div style="background:${bg};border:1px solid ${color}33;border-radius:16px;padding:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
                        <div>
                            <span style="font-weight:600;color:#f1f5f9;font-size:1rem;">${getCategoryIcon(b.category)} ${b.category}</span>
                            <span style="font-size:0.75rem;color:#64748b;margin-left:0.5rem;">${b.period}</span>
                        </div>
                        <button onclick="deleteBudget(${b.id})" style="background:none;border:none;cursor:pointer;font-size:0.9rem;">ğŸ—‘ï¸</button>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:#64748b;margin-bottom:0.5rem;">
                        <span>Spent: <b style="color:#f1f5f9;">${formatINR(b.spent)}</b></span>
                        <span>Budget: <b style="color:#f1f5f9;">${formatINR(b.budget_amount)}</b></span>
                    </div>
                    <div style="background:rgba(255,255,255,0.06);border-radius:99px;height:12px;overflow:hidden;">
                        <div style="background:${color};height:100%;border-radius:99px;width:${pct}%;transition:width 0.5s ease;"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.8rem;">
                        <span style="color:${color};font-weight:600;">${b.percentage}% used</span>
                        <span style="color:#64748b;">Remaining: ${formatINR(b.remaining)}</span>
                    </div>
                </div>`;
            }).join('');

            list.innerHTML = data.budgets.map(b => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;border-bottom:1px solid rgba(255,255,255,0.06);">
                    <span>${getCategoryIcon(b.category)} ${b.category} (${b.period})</span>
                    <span style="font-weight:600;">${formatINR(b.spent)} / ${formatINR(b.budget_amount)}</span>
                </div>
            `).join('');
        }

        function showAddBudget() { document.getElementById('budgetModal').style.display = 'flex'; }
        function closeBudgetModal() { document.getElementById('budgetModal').style.display = 'none'; }

        async function saveBudget() {
            const data = {
                category: document.getElementById('budgetCategory').value,
                amount: parseFloat(document.getElementById('budgetAmount').value),
                period: document.getElementById('budgetPeriod').value,
                alert_threshold: parseInt(document.getElementById('budgetThreshold').value) || 80
            };
            if (!data.amount) { showToast('Budget amount is required', 'error'); return; }
            const res = await apiPost('/api/budgets', data);
            if (res.success) { showToast('Budget created!', 'success'); closeBudgetModal(); loadBudgets(); }
            else { showToast(res.error || 'Failed', 'error'); }
        }

        async function deleteBudget(id) {
            if (!confirm('Delete this budget?')) return;
            const res = await apiDelete(`/api/budgets/${id}`);
            if (res.success) { showToast('Budget deleted', 'success'); loadBudgets(); }
        }

        async function loadNotifBadge() {
            const data = await apiGet('/api/notifications/unread-count');
            if (data.success && data.count > 0) {
                document.getElementById('notifBadge').style.display = 'inline';
                document.getElementById('notifBadge').textContent = data.count;
            }
        }

        loadBudgets();
        loadNotifBadge();
    </script>
</body>

</html>