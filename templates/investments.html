<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investments ‚Äî SmartMail Expense Tracker</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/app.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/dashboard" style="text-decoration:none;color:#f1f5f9;display:flex;align-items:center;gap:8px;">
                <img src="/static/logo.svg" alt="SmartMail Logo" class="nav-logo">
                <span class="nav-brand-text">SmartMail Tracker</span>
            </a>
        </div>
        <div class="nav-links">
            <a href="/dashboard" class="nav-link">Dashboard</a>
            <a href="/subscriptions" class="nav-link">Subscriptions</a>
            <a href="/budgets" class="nav-link">Budgets</a>
            <a href="/investments" class="nav-link active">Investments</a>
            <a href="/calendar" class="nav-link">Calendar</a>
            <a href="/reports" class="nav-link">Reports</a>
            <a href="/settings" class="nav-link">Settings</a>
            <a href="/notifications" class="nav-link notif-bell" title="Notifications">üîî<span id="notifBadge"
                    class="notif-badge" style="display:none;">0</span></a>
            <span style="color:#64748b;font-size:0.85rem;margin-left:0.5rem;">{{ username }}</span>
            <button onclick="logout()" class="btn-logout"
                style="background:none;border:1px solid rgba(255,255,255,0.08);padding:6px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;color:#64748b;">Logout</button>
        </div>
    </nav>

    <div class="container" style="max-width:1100px;margin:0 auto;padding:2rem 1.5rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;">
            <div>
                <h1 style="font-size:1.8rem;font-weight:700;color:#f1f5f9;margin:0;">üìà Investments</h1>
                <p style="color:#64748b;font-size:0.9rem;margin:0.3rem 0 0;">Track your portfolio ‚Äî Mutual Funds,
                    Stocks, FD, SIP, PPF & more</p>
            </div>
            <button onclick="showAddInvestment()" class="btn btn-primary" style="padding:8px 16px;font-size:0.85rem;">+
                Add Investment</button>
        </div>

        <!-- Portfolio Summary -->
        <div
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.25rem;margin-bottom:2rem;">
            <div
                style="background:linear-gradient(135deg,#560BAD,#7209B7);color:white;border-radius:16px;padding:1.5rem;">
                <div style="font-size:0.8rem;opacity:0.8;">Total Invested</div>
                <div id="totalInvested" style="font-size:1.6rem;font-weight:700;">‚Çπ0</div>
            </div>
            <div
                style="background:linear-gradient(135deg,#4361EE,#3A0CA3);color:white;border-radius:16px;padding:1.5rem;">
                <div style="font-size:0.8rem;opacity:0.8;">Current Value</div>
                <div id="currentValue" style="font-size:1.6rem;font-weight:700;">‚Çπ0</div>
            </div>
            <div id="plCard"
                style="background:linear-gradient(135deg,#06D6A0,#059669);color:white;border-radius:16px;padding:1.5rem;">
                <div style="font-size:0.8rem;opacity:0.8;">P/L</div>
                <div id="totalPL" style="font-size:1.6rem;font-weight:700;">‚Çπ0</div>
                <div id="plPercent" style="font-size:0.85rem;opacity:0.9;">0%</div>
            </div>
            <div
                style="background:linear-gradient(135deg,#F72585,#B5179E);color:white;border-radius:16px;padding:1.5rem;">
                <div style="font-size:0.8rem;opacity:0.8;">Holdings</div>
                <div id="holdingsCount" style="font-size:1.6rem;font-weight:700;">0</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;margin-bottom:2rem;">
            <div class="settings-card" style="border-radius:16px;padding:1.5rem;">
                <h3 style="margin:0 0 1rem;font-size:1rem;">Portfolio Breakdown</h3>
                <canvas id="portfolioChart" height="200"></canvas>
            </div>
            <div class="settings-card" style="border-radius:16px;padding:1.5rem;">
                <h3 style="margin:0 0 1rem;font-size:1rem;">P/L by Type</h3>
                <div id="plByType"></div>
            </div>
        </div>

        <!-- Investments List -->
        <div class="settings-card" style="border-radius:16px;padding:1.5rem;">
            <h3 style="margin:0 0 1rem;font-size:1.1rem;">Your Investments</h3>
            <div id="investmentsList">
                <div style="text-align:center;color:#94a3b8;padding:2rem;">Loading investments...</div>
            </div>
        </div>
    </div>

    <!-- Add Investment Modal -->
    <div id="invModal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
        <div
            style="background:rgba(15,15,40,0.95);border-radius:16px;padding:2rem;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 80px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);">
            <h3 style="margin:0 0 1.5rem;font-size:1.2rem;">Add Investment</h3>
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <input id="invName" type="text" placeholder="Investment name (e.g., HDFC Flexi Cap Fund)"
                    class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;background:rgba(255,255,255,0.05);color:#f1f5f9;">
                <select id="invType" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;background:rgba(255,255,255,0.05);color:#f1f5f9;">
                    <option value="Mutual Fund">Mutual Fund</option>
                    <option value="SIP">SIP</option>
                    <option value="Stocks">Stocks</option>
                    <option value="FD">Fixed Deposit</option>
                    <option value="RD">Recurring Deposit</option>
                    <option value="PPF">PPF</option>
                    <option value="NPS">NPS</option>
                    <option value="Gold">Gold</option>
                    <option value="Real Estate">Real Estate</option>
                    <option value="Other">Other</option>
                </select>
                <input id="invAmount" type="number" placeholder="Amount invested (‚Çπ)" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;background:rgba(255,255,255,0.05);color:#f1f5f9;">
                <input id="invCurrent" type="number" placeholder="Current value (‚Çπ)" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;background:rgba(255,255,255,0.05);color:#f1f5f9;">
                <input id="invPlatform" type="text" placeholder="Platform (e.g., Groww, Zerodha)" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;background:rgba(255,255,255,0.05);color:#f1f5f9;">
                <input id="invDate" type="date" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;background:rgba(255,255,255,0.05);color:#f1f5f9;">
                <input id="invNotes" type="text" placeholder="Notes (optional)" class="form-input"
                    style="padding:10px 14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-size:0.9rem;background:rgba(255,255,255,0.05);color:#f1f5f9;">
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1.5rem;justify-content:flex-end;">
                <button onclick="closeInvModal()" class="btn btn-secondary"
                    style="padding:8px 20px;font-size:0.85rem;background:rgba(255,255,255,0.06);color:#94a3b8;border:1px solid rgba(255,255,255,0.08);">Cancel</button>
                <button onclick="saveInvestment()" class="btn btn-primary"
                    style="padding:8px 20px;font-size:0.85rem;">Save</button>
            </div>
        </div>
    </div>

    <script>
        let portfolioChart = null;

        async function loadInvestments() {
            const [list, summary] = await Promise.all([
                apiGet('/api/investments'),
                apiGet('/api/investments/summary')
            ]);

            if (summary.success) {
                document.getElementById('totalInvested').textContent = formatINR(summary.total_invested);
                document.getElementById('currentValue').textContent = formatINR(summary.total_current);
                document.getElementById('totalPL').textContent = (summary.total_pl >= 0 ? '+' : '') + formatINR(summary.total_pl);
                document.getElementById('plPercent').textContent = (summary.total_pl >= 0 ? '+' : '') + summary.pl_percent + '%';
                document.getElementById('holdingsCount').textContent = summary.count;

                const plCard = document.getElementById('plCard');
                plCard.style.background = summary.total_pl >= 0
                    ? 'linear-gradient(135deg,#06D6A0,#059669)'
                    : 'linear-gradient(135deg,#EF476F,#dc2626)';

                // Portfolio chart
                const types = Object.keys(summary.by_type);
                const values = types.map(t => summary.by_type[t].current);
                const colors = ['#7209B7', '#4361EE', '#06D6A0', '#F72585', '#FF6B6B', '#FFD166', '#118AB2', '#B5179E', '#560BAD', '#64748b'];
                if (portfolioChart) portfolioChart.destroy();
                portfolioChart = new Chart(document.getElementById('portfolioChart'), {
                    type: 'doughnut',
                    data: { labels: types, datasets: [{ data: values, backgroundColor: colors.slice(0, types.length) }] },
                    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } } }
                });

                // P/L by type
                document.getElementById('plByType').innerHTML = types.map(t => {
                    const d = summary.by_type[t];
                    const pl = d.current - d.invested;
                    const pct = d.invested > 0 ? (pl / d.invested * 100).toFixed(1) : 0;
                    return `<div style="display:flex;justify-content:space-between;padding:0.6rem 0;border-bottom:1px solid rgba(255,255,255,0.06);">
                        <span style="font-size:0.9rem;">${t} (${d.count})</span>
                        <span style="font-weight:600;color:${pl >= 0 ? '#059669' : '#dc2626'};">${pl >= 0 ? '+' : ''}${formatINR(pl)} (${pl >= 0 ? '+' : ''}${pct}%)</span>
                    </div>`;
                }).join('') || '<div style="text-align:center;color:#94a3b8;padding:1rem;">No investments yet</div>';
            }

            if (list.success) {
                const container = document.getElementById('investmentsList');
                if (!list.investments.length) {
                    container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:2rem;">No investments yet. Click <b>+ Add Investment</b> to start tracking your portfolio.</div>';
                    return;
                }
                container.innerHTML = list.investments.map(inv => {
                    const pl = (inv.current_value || inv.amount_invested) - inv.amount_invested;
                    const pct = inv.amount_invested > 0 ? (pl / inv.amount_invested * 100).toFixed(1) : 0;
                    return `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid rgba(255,255,255,0.06);">
                        <div>
                            <div style="font-weight:600;color:#f1f5f9;font-size:0.95rem;">${inv.name}</div>
                            <div style="font-size:0.8rem;color:#64748b;">${inv.type} ${inv.platform ? '‚Ä¢ ' + inv.platform : ''} ${inv.purchase_date ? '‚Ä¢ ' + formatDateIndian(inv.purchase_date) : ''}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700;color:#f1f5f9;">${formatINR(inv.current_value || inv.amount_invested)}</div>
                            <div style="font-size:0.8rem;color:${pl >= 0 ? '#059669' : '#dc2626'};font-weight:600;">${pl >= 0 ? '+' : ''}${formatINR(pl)} (${pl >= 0 ? '+' : ''}${pct}%)</div>
                        </div>
                        <button onclick="deleteInv(${inv.id})" style="background:none;border:none;cursor:pointer;font-size:1rem;margin-left:0.5rem;">üóëÔ∏è</button>
                    </div>`;
                }).join('');
            }
        }

        function showAddInvestment() { document.getElementById('invModal').style.display = 'flex'; }
        function closeInvModal() { document.getElementById('invModal').style.display = 'none'; }

        async function saveInvestment() {
            const data = {
                name: document.getElementById('invName').value,
                type: document.getElementById('invType').value,
                amount_invested: parseFloat(document.getElementById('invAmount').value),
                current_value: parseFloat(document.getElementById('invCurrent').value) || undefined,
                platform: document.getElementById('invPlatform').value,
                purchase_date: document.getElementById('invDate').value,
                notes: document.getElementById('invNotes').value
            };
            if (!data.name || !data.amount_invested) { showToast('Name and amount required', 'error'); return; }
            const res = await apiPost('/api/investments', data);
            if (res.success) { showToast('Investment added!', 'success'); closeInvModal(); loadInvestments(); }
            else { showToast(res.error || 'Failed', 'error'); }
        }

        async function deleteInv(id) {
            if (!confirm('Delete this investment?')) return;
            const res = await apiDelete(`/api/investments/${id}`);
            if (res.success) { showToast('Investment deleted', 'success'); loadInvestments(); }
        }

        async function loadNotifBadge() {
            const data = await apiGet('/api/notifications/unread-count');
            if (data.success && data.count > 0) {
                document.getElementById('notifBadge').style.display = 'inline';
                document.getElementById('notifBadge').textContent = data.count;
            }
        }

        loadInvestments();
        loadNotifBadge();
    </script>
</body>

</html>